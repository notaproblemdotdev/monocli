---
phase: 03-dashboard-ui
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/monocli/ui/main_screen.py
  - src/monocli/ui/sections.py
autonomous: true
gap_closure: true
must_haves:
  truths:
    - Pressing 'o' key opens the selected item in the default browser
    - Keyboard navigation (arrows/j/k) works in the currently focused section after Tab switching
    - Pressing 'q' key quits the application
  artifacts:
    - path: "src/monocli/ui/sections.py"
      provides: "Fixed get_selected_url() to handle RowKey objects"
      contains: "hasattr(row_key, 'value')"
      or_contains: "row_key.value"
    - path: "src/monocli/ui/main_screen.py"
      provides: "Fixed Tab navigation to call focus_table()"
      contains: "self.work_section.focus_table()"
    - path: "src/monocli/ui/main_screen.py"
      provides: "Added 'q' key binding for quit"
      contains: "('q', 'quit', 'Quit')"
---

<objective>
Fix keyboard navigation and interaction issues: ensure 'o' key opens selected items in browser, Tab navigation properly focuses the work items section, and 'q' key quits the application.

Purpose: These are major functional issues that prevent core dashboard interactions from working correctly.
Output: Updated main_screen.py and sections.py with all three navigation fixes applied.
</objective>

<execution_context>
@/Users/pg/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/pg/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-dashboard-ui/03-dashboard-ui-UAT.md
@src/monocli/ui/main_screen.py
@src/monocli/ui/sections.py

## Gap Context

This plan addresses 3 diagnosed gaps from UAT.md (all major severity):

**Gap 4: 'o' key doesn't open browser (major)**
- Truth: Pressing 'o' key opens the selected item in the default browser
- Root cause: get_selected_url() uses isinstance(row_key, str) but DataTable returns RowKey wrapper objects, not strings
- Artifacts affected:
  - MergeRequestSection.get_selected_url() line 334
  - WorkItemSection.get_selected_url() line 626
- Fix: Access row_key.value instead of row_key directly, or use hasattr(row_key, 'value') to check

**Gap 5: Navigation broken after Tab (major)**
- Truth: Keyboard navigation (arrows/j/k) works in the currently focused section after Tab switching
- Root cause: Work Items section uses focus() instead of focus_table() when switching via Tab, so DataTable doesn't receive focus
- Artifact: main_screen.py line 264
- Current code: `self.work_section.focus()`
- Fix: Change to `self.work_section.focus_table()`

**Gap 6: 'q' key doesn't quit (major)**
- Truth: Pressing 'q' key quits the application
- Root cause: BINDINGS list in MainScreen is missing the ('q', 'quit', 'Quit') entry
- Artifact: main_screen.py lines 37-42
- Current BINDINGS: Only tab, o, j, k
- Fix: Add ('q', 'quit', 'Quit') to BINDINGS list
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix 'o' key browser open (RowKey.value issue)</name>
  <files>src/monocli/ui/sections.py</files>
  <action>
    Fix the get_selected_url() method in both MergeRequestSection (line ~334) and WorkItemSection (line ~626) to handle RowKey wrapper objects.
    
    The issue is that DataTable stores row keys as RowKey objects, not plain strings, so `isinstance(row_key, str)` always returns False.
    
    **Fix for MergeRequestSection.get_selected_url() (around line 334):**
    
    Current code:
    ```python
    # The row key is the URL we stored when adding the row
    row_key = row_keys[row_index]
    if isinstance(row_key, str):
        return row_key
    ```
    
    Change to:
    ```python
    # The row key is the URL we stored when adding the row
    row_key = row_keys[row_index]
    if hasattr(row_key, 'value'):
        return str(row_key.value)
    elif isinstance(row_key, str):
        return row_key
    ```
    
    **Fix for WorkItemSection.get_selected_url() (around line 626):**
    
    Apply the exact same fix:
    ```python
    # The row key is the URL we stored when adding the row
    row_key = row_keys[row_index]
    if hasattr(row_key, 'value'):
        return str(row_key.value)
    elif isinstance(row_key, str):
        return row_key
    ```
    
    This ensures that if row_key is a RowKey wrapper object, we access its .value attribute to get the actual URL string.
  </action>
  <verify>grep -n "hasattr(row_key, 'value')" src/monocli/ui/sections.py | wc -l | grep -q "2"</verify>
  <done>Both get_selected_url() methods check for row_key.value attribute before isinstance check</done>
</task>

<task type="auto">
  <name>Task 2: Fix Tab navigation focus issue</name>
  <files>src/monocli/ui/main_screen.py</files>
  <action>
    Fix the switch_section() method in MainScreen to call focus_table() instead of focus() when switching to the work items section.
    
    Current code (around line 264):
    ```python
    else:
        self.active_section = "work"
        self.work_section.focus()
    ```
    
    Change to:
    ```python
    else:
        self.active_section = "work"
        self.work_section.focus_table()
    ```
    
    The issue is that work_section.focus() focuses the container widget, not the internal DataTable. We need to call work_section.focus_table() (which exists in BaseSection and focuses self._data_table) so keyboard events reach the DataTable for navigation.
  </action>
  <verify>grep -n "self.work_section.focus_table()" src/monocli/ui/main_screen.py</verify>
  <done>switch_section() calls self.work_section.focus_table() instead of self.work_section.focus()</done>
</task>

<task type="auto">
  <name>Task 3: Add 'q' key binding for quit</name>
  <files>src/monocli/ui/main_screen.py</files>
  <action>
    Add the 'q' key binding to MainScreen.BINDINGS to enable quitting the application.
    
    Current BINDINGS (lines 37-42):
    ```python
    BINDINGS = [
        ("tab", "switch_section", "Switch Section"),
        ("o", "open_selected", "Open in Browser"),
        ("j", "move_down", "Up"),
        ("k", "move_up", "Down"),
    ]
    ```
    
    Note: The current code has a bug - "j" is mapped to "move_down" with label "Up" and "k" is mapped to "move_up" with label "Down". These are swapped! Fix them while adding the quit binding.
    
    Change to:
    ```python
    BINDINGS = [
        ("tab", "switch_section", "Switch Section"),
        ("o", "open_selected", "Open in Browser"),
        ("j", "move_down", "Down"),
        ("k", "move_up", "Up"),
        ("q", "quit", "Quit"),
    ]
    ```
    
    Also ensure the action_quit() method exists. It should be inherited from Screen class, but verify it works. If needed, add:
    
    ```python
    def action_quit(self) -> None:
        """Quit the application."""
        self.app.exit()
    ```
  </action>
  <verify>grep -E "^\s+\('q'.*quit" src/monocli/ui/main_screen.py</verify>
  <done>BINDINGS includes ('q', 'quit', 'Quit') and j/k descriptions are corrected</done>
</task>

</tasks>

<verification>
Run these checks to verify all gaps are closed:

1. Verify 'o' key RowKey fix in both methods:
   ```bash
   grep -B2 -A2 "hasattr(row_key, 'value')" src/monocli/ui/sections.py
   ```
   Should show the fix in both MergeRequestSection and WorkItemSection.

2. Verify Tab navigation fix:
   ```bash
   grep -n "focus_table()" src/monocli/ui/main_screen.py
   ```
   Should show `self.work_section.focus_table()` in switch_section().

3. Verify 'q' key binding:
   ```bash
   grep -A10 "BINDINGS = \[" src/monocli/ui/main_screen.py
   ```
   Should show ('q', 'quit', 'Quit') in the list.

4. Run type checker:
   ```bash
   uv run ty src/monocli/ui/
   ```

5. Run linter:
   ```bash
   uv run ruff check src/monocli/ui/
   ```

6. Run tests to ensure navigation still works:
   ```bash
   uv run pytest tests/ui/test_navigation.py -v
   ```
</verification>

<success_criteria>
All 3 gaps from UAT.md are closed:
- [ ] Gap 4: 'o' key opens selected item URL in default browser (RowKey.value handled correctly)
- [ ] Gap 5: Tab switching properly focuses the work items DataTable (focus_table() called)
- [ ] Gap 6: 'q' key quits the dashboard and returns to terminal (binding added)
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-ui/03-07-SUMMARY.md`
</output>
