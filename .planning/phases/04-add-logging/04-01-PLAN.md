---
phase: 04-add-logging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/monocli/logging_config.py
  - src/monocli/__init__.py
  - src/monocli/__main__.py
autonomous: true
must_haves:
  truths:
    - "structlog is configured for structured logging"
    - "Logs write to both console and file"
    - "Log level is configurable via environment variable"
    - "Debug mode enables verbose logging"
  artifacts:
    - path: "pyproject.toml"
      provides: "structlog dependency"
    - path: "src/monocli/logging_config.py"
      provides: "Logging configuration module"
      exports: ["configure_logging", "get_logger"]
    - path: "src/monocli/__init__.py"
      provides: "Package initialization with logging setup"
    - path: "src/monocli/__main__.py"
      provides: "Entry point with debug flag support"
  key_links:
    - from: "__main__.py"
      to: "logging_config.py"
      via: "calls configure_logging() on startup"
    - from: "all modules"
      to: "logging_config.py"
      via: "imports get_logger() for structured logging"
---

<objective>
Set up structlog for structured logging with console and file output, configurable log levels, and debug mode support.

Purpose: Provide proper logging infrastructure for debugging and monitoring the application.
Output: Configured structlog logger that writes to console and file with structured JSON format.
</objective>

<execution_context>
@/Users/pg/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

## Phase Context

Phase 4: Add Logging with Structlog

Success Criteria:
1. Application uses structlog for structured logging
2. Logs are written to both console and file
3. Log level is configurable via environment variable
4. Sensitive data is not logged
5. Debug mode flag enables verbose logging

## Structlog Setup Requirements

- Use structlog for structured JSON logging
- Console output: human-readable format for development
- File output: JSON format for production/analysis
- Log directory: ~/.local/share/monocli/logs/
- Log file naming: monocli_YYYY-MM-DD.log
- Configurable LOG_LEVEL environment variable
- --debug flag for verbose logging
- Sensitive data filtering (tokens, passwords)

## Integration Points

- Logging must be configured before app starts
- All adapters (GitLab, Jira) should use structured logging
- UI components can log user actions
- Log rotation for file output
</context>

<tasks>

<task type="auto">
  <name>Add structlog dependency to pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
    Add structlog as a dependency in pyproject.toml:
    
    1. Add to dependencies section:
       dependencies = [
           "textual>=7.5.0",
           "pydantic>=2.12.5",
           "structlog>=24.1.0",
       ]
    
    2. Run uv sync to update lock file
  </action>
  <verify>cd /Users/pg/Coding/_bucket/monocli && uv sync && uv run python -c "import structlog; print('structlog version:', structlog.__version__)"</verify>
  <done>structlog is installed and importable</done>
</task>

<task type="auto">
  <name>Create logging configuration module</name>
  <files>src/monocli/logging_config.py</files>
  <action>
    Create src/monocli/logging_config.py with complete structlog configuration:
    
    1. Import required modules:
       - structlog
       - logging
       - os
       - pathlib.Path
       - datetime
    
    2. Define constants:
       - LOG_DIR = Path.home() / ".local" / "share" / "monocli" / "logs"
       - DEFAULT_LOG_LEVEL = "INFO"
    
    3. Create ensure_log_dir() function:
       - Create log directory if it doesn't exist
    
    4. Create get_log_file_path() function:
       - Return path with date suffix: monocli_YYYY-MM-DD.log
    
    5. Create configure_logging() function:
       - Accept debug: bool parameter
       - Set log level based on debug flag or LOG_LEVEL env var
       - Configure structlog processors for structured output
       - Set up console renderer (human-readable, colors)
       - Set up file renderer (JSON format)
       - Configure standard library logging integration
    
    6. Create get_logger() function:
       - Return structlog.get_logger() for modules to use
    
    7. Add sensitive data filtering:
       - Create filter_sensitive_data processor
       - Mask tokens, passwords, auth headers
    
    Example structlog configuration:
    ```python
    structlog.configure(
        processors=[
            structlog.stdlib.filter_by_level,
            structlog.stdlib.add_logger_name,
            structlog.stdlib.add_log_level,
            structlog.stdlib.PositionalArgumentsFormatter(),
            structlog.processors.TimeStamper(fmt="iso"),
            structlog.processors.StackInfoRenderer(),
            structlog.processors.format_exc_info,
            filter_sensitive_data,  # Custom processor
            structlog.processors.UnicodeDecoder(),
        ],
        context_class=dict,
        logger_factory=structlog.stdlib.LoggerFactory(),
        wrapper_class=structlog.stdlib.BoundLogger,
        cache_logger_on_first_use=True,
    )
    ```
  </action>
  <verify>cd /Users/pg/Coding/_bucket/monocli && uv run python -c "from monocli.logging_config import configure_logging, get_logger; configure_logging(debug=True); logger = get_logger(); logger.info('Test log', key='value')"</verify>
  <done>Logging config module created and functional</done>
</task>

<task type="auto">
  <name>Initialize logging in package __init__.py</name>
  <files>src/monocli/__init__.py</files>
  <action>
    Update src/monocli/__init__.py to expose logging functions:
    
    1. Add imports:
       - from monocli.logging_config import configure_logging, get_logger
    
    2. Add to __all__:
       - "configure_logging"
       - "get_logger"
    
    3. This allows other modules to import:
       - from monocli import get_logger
       - from monocli.logging_config import configure_logging
  </action>
  <verify>cd /Users/pg/Coding/_bucket/monocli && uv run python -c "from monocli import get_logger; print('Import successful')"</verify>
  <done>Package exports logging functions correctly</done>
</task>

<task type="auto">
  <name>Add debug flag to entry point</name>
  <files>src/monocli/__main__.py</files>
  <action>
    Update src/monocli/__main__.py to support debug mode:
    
    1. Import configure_logging from monocli.logging_config
    
    2. Add argument parsing for --debug flag:
       - Use argparse or sys.argv
       - Support: uv run monocli --debug
    
    3. Configure logging early in main():
       - Parse arguments before creating app
       - Call configure_logging(debug=args.debug)
       - Log startup message with version info
    
    4. Example structure:
       ```python
       def main() -> None:
           parser = argparse.ArgumentParser(description="Mono CLI Dashboard")
           parser.add_argument("--debug", action="store_true", help="Enable debug logging")
           args = parser.parse_args()
           
           configure_logging(debug=args.debug)
           logger = get_logger()
           logger.info("Starting Mono CLI", debug_mode=args.debug)
           
           app = MonoApp()
           app.run()
       ```
  </action>
  <verify>cd /Users/pg/Coding/_bucket/monocli && uv run python -m monocli --help | grep -q debug && echo "Debug flag supported"</verify>
  <done>Entry point supports --debug flag and configures logging</done>
</task>

<task type="auto">
  <name>Add logging to CLI adapters</name>
  <files>src/monocli/adapters/gitlab.py, src/monocli/adapters/jira.py, src/monocli/adapters/detection.py</files>
  <action>
    Add structured logging to all adapter modules:
    
    1. In each adapter file (gitlab.py, jira.py, detection.py):
       - Add: from monocli import get_logger
       - Add at module level: logger = get_logger()
    
    2. Add logging calls:
       - GitLabAdapter: log fetch operations, auth checks, errors
       - JiraAdapter: log fetch operations, auth checks, errors
       - DetectionRegistry: log CLI detection results
    
    3. Example logging patterns:
       ```python
       logger.info("Fetching merge requests", group=group, assignee=assignee)
       logger.debug("CLI command executed", cmd="glab mr list", exit_code=0)
       logger.warning("CLI not authenticated", cli="glab")
       logger.error("Failed to fetch data", cli="acli", error=str(e))
       ```
    
    4. Ensure sensitive data is NOT logged:
       - Don't log tokens, passwords
       - Log command structure but not actual tokens
  </action>
  <verify>cd /Users/pg/Coding/_bucket/monocli && uv run python -c "from monocli.adapters.gitlab import GitLabAdapter; from monocli.adapters.jira import JiraAdapter; print('Adapters import successfully with logging')"</verify>
  <done>All adapters use structured logging</done>
</task>

<task type="auto">
  <name>Test logging configuration</name>
  <files>tests/test_logging.py</files>
  <action>
    Create tests for logging configuration:
    
    1. Create tests/test_logging.py with tests:
       - test_configure_logging_creates_log_dir
       - test_configure_logging_sets_level_debug
       - test_configure_logging_sets_level_info
       - test_get_logger_returns_structlog_logger
       - test_log_file_created
       - test_sensitive_data_filtered
    
    2. Test that logs are written to file:
       - Run configure_logging
       - Log a message
       - Verify file exists in ~/.local/share/monocli/logs/
    
    3. Test sensitive data filtering:
       - Log message with token
       - Verify token is masked in output
  </action>
  <verify>cd /Users/pg/Coding/_bucket/monocli && uv run pytest tests/test_logging.py -v</verify>
  <done>All logging tests pass</done>
</task>

</tasks>

<verification>
1. structlog is installed and importable
2. Logging configuration module exists with all required functions
3. Package __init__.py exports logging functions
4. Entry point supports --debug flag
5. All adapters use structured logging
6. Logs write to console and file
7. Sensitive data is filtered
8. Tests verify logging functionality
</verification>

<success_criteria>
- structlog dependency added to pyproject.toml
- logging_config.py module with configure_logging() and get_logger()
- Logs write to ~/.local/share/monocli/logs/monocli_YYYY-MM-DD.log
- Console output is human-readable with colors
- File output is structured JSON
- --debug flag enables verbose logging
- LOG_LEVEL environment variable configures log level
- Sensitive data (tokens, passwords) is filtered/masked
- All adapters log their operations
- Tests verify logging configuration
</success_criteria>

<output>
After completion, create `.planning/phases/04-add-logging/04-01-SUMMARY.md`
</output>
